// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum VideoStatus {
  UPLOADING
  PROCESSING
  READY
  ERROR
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TRUE_FALSE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PENDING
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
  MERCADO_PAGO
}

model User {
  id               String        @id @default(uuid())
  name             String
  email            String        @unique
  passwordHash     String
  role             UserRole      @default(STUDENT)
  agreedToTerms    Boolean       @default(false)
  agreedToPrivacy  Boolean       @default(false)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  createdCourses   Course[]      @relation("CourseCreator")
  enrollments      Enrollment[]
  auditLogs        AuditLog[]
  subscription     Subscription?
  payments         Payment[]

  @@index([email])
  @@index([role])
}

model Course {
  id              String       @id @default(uuid())
  title           String
  description     String       @db.Text
  coverImage      String?
  workloadHours   Int
  isPublished     Boolean      @default(false)
  createdById     String
  createdBy       User         @relation("CourseCreator", fields: [createdById], references: [id])
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  modules         Module[]
  enrollments     Enrollment[]

  @@index([isPublished])
  @@index([createdById])
}

model Module {
  id          String    @id @default(uuid())
  courseId    String
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title       String
  order       Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  lessons     Lesson[]
  quizzes     Quiz[]

  @@unique([courseId, order])
  @@index([courseId])
}

model Lesson {
  id              String    @id @default(uuid())
  moduleId        String
  module          Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  title           String
  order           Int
  videoId         String?   @unique
  video           Video?    @relation(fields: [videoId], references: [id])
  minWatchPercent Int       @default(80)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  progress        LessonProgress[]

  @@unique([moduleId, order])
  @@index([moduleId])
  @@index([videoId])
}

model Video {
  id            String      @id @default(uuid())
  originalKey   String
  hlsKeyPrefix  String?
  durationSec   Int?
  status        VideoStatus @default(UPLOADING)
  sizeBytes     BigInt
  thumbnails    String[]
  subtitles     Json        @default("[]")
  uploadId      String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  lesson        Lesson?

  @@index([status])
}

model Enrollment {
  id              String      @id @default(uuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId        String
  course          Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progressPercent Int         @default(0)
  completedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  lessonProgress  LessonProgress[]
  attempts        Attempt[]
  certificate     Certificate?

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model LessonProgress {
  id              String      @id @default(uuid())
  enrollmentId    String
  enrollment      Enrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lessonId        String
  lesson          Lesson      @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  watchedSeconds  Int         @default(0)
  lastPositionSec Int         @default(0)
  completedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@unique([enrollmentId, lessonId])
  @@index([enrollmentId])
  @@index([lessonId])
}

model Quiz {
  id              String    @id @default(uuid())
  moduleId        String
  module          Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  title           String
  description     String?   @db.Text
  minScore        Int       @default(70)
  attemptsAllowed Int       @default(3)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  questions       Question[]
  attempts        Attempt[]

  @@index([moduleId])
}

model Question {
  id          String        @id @default(uuid())
  quizId      String
  quiz        Quiz          @relation(fields: [quizId], references: [id], onDelete: Cascade)
  type        QuestionType
  statement   String        @db.Text
  options     Json          @default("[]")
  answerKey   String[]
  order       Int
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([quizId])
}

model Attempt {
  id            String      @id @default(uuid())
  quizId        String
  quiz          Quiz        @relation(fields: [quizId], references: [id], onDelete: Cascade)
  enrollmentId  String
  enrollment    Enrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  score         Int
  answers       Json        @default("[]")
  startedAt     DateTime    @default(now())
  finishedAt    DateTime?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([quizId])
  @@index([enrollmentId])
}

model Certificate {
  id            String      @id @default(uuid())
  enrollmentId  String      @unique
  enrollment    Enrollment  @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  code          String      @unique
  pdfKey        String
  issuedAt      DateTime    @default(now())

  @@index([code])
}

model AuditLog {
  id          String    @id @default(uuid())
  userId      String?
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  action      String
  entity      String
  entityId    String?
  meta        Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

model Subscription {
  id                String             @id @default(uuid())
  userId            String             @unique
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  status            SubscriptionStatus @default(PENDING)
  planId            String
  planName          String             @default("Plano Premium AutoOn")
  planPrice         Float              @default(99.99)
  startDate         DateTime?
  endDate           DateTime?
  autoRenew         Boolean            @default(true)
  cancelledAt       DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([userId])
  @@index([status])
}

model Payment {
  id                String          @id @default(uuid())
  userId            String
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount            Float
  currency          String          @default("BRL")
  status            PaymentStatus   @default(PENDING)
  provider          PaymentProvider
  providerPaymentId String?
  providerCustomerId String?
  metadata          Json?
  paidAt            DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([userId])
  @@index([status])
  @@index([providerPaymentId])
}
